!function(){function e(t,n){var e=n||{};this.svr=t,this.prt=e.port||1883,this.ka=e.keep_alive||60,this.usr=e.username,this.pwd=e.password,this.cn=!1,this.ri=e.reconnect_interval||2e3,this.wt=e.will_topic,this.wp=e.will_payload||"",c=this}var c,r=String.fromCharCode;function o(t){return r(t.length>>8,255&t.length)+t}function i(t,n,e){return r(t,n.length+e.length)+n+e}e.prototype._scktClosed=function(){c.con&&(clearInterval(c.con),c.con=null),c.x1&&(clearInterval(c.x1),c.x1=null),c.cn=!1,delete c.cl,c.emit("disconnected")},e.prototype.connect=function(){function t(){c.con&&(clearInterval(c.con),c.con=null);try{c.cl.write(function(t){var n=0,e=o(t);return c.wt&&(n|=36,e+=o(c.wt)+o(c.wp)),c.usr&&c.pwd&&(n|=c.usr?128:0,n|=c.usr&&c.pwd?64:0,e+=o(c.usr)+o(c.pwd)),i(16,o("MQTT")+r(4,n,c.ka>>8,255&c.ka),e)}(getSerial())),c.emit("connected"),c.cn=!0,c.x1=setInterval(function(){c.cn&&c.cl.write(r(192,0))},c.ka<<10),c.cl.on("data",function(t){if(t.charCodeAt(0)>>4==3){var n=t.charCodeAt(2)<<8|t.charCodeAt(3),e={topic:t.substr(4,n),message:t.substr(4+n,t.charCodeAt(1)-n)};c.emit("message",e)}}.bind(c)),c.cl.on("end",c._scktClosed)}catch(t){c._scktClosed()}}c.cn||c.con||(c.con=setInterval(function(){c.cl&&(c.cl.end(),delete c.cl);try{c.cl=require("net").connect({host:c.svr,port:c.prt},t)}catch(t){c._scktClosed()}},c.ri))},e.prototype.subscribe=function(t){c.cl.write(i(130,r(256,1),o(t)+r(1)))},e.prototype.publish=function(t,n){if(127<t.length+n.length)throw"tMQTT-TL";c.cn&&(c.cl.write(i(49,o(t),n)),c.emit("published"))},e.prototype.disconnect=function(){if(c.cn)try{c.cl.write(r(224,0))}catch(t){c._scktClosed()}},exports.create=function(t,n){return new e(t,n)}}();